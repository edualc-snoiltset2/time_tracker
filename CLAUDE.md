# CLAUDE.md

This file provides guidance for AI assistants working with this codebase.

## Project Overview

Time Tracker is a cross-platform Flutter application for freelancers and small businesses to track time, manage clients/projects, handle expenses, generate invoices, and view reports. It targets Android, iOS, macOS, Linux, Windows, and Web.

## Tech Stack

- **Language:** Dart (SDK ^3.8.1)
- **Framework:** Flutter (stable channel)
- **State Management:** Provider (^6.1.2)
- **Database:** SQLite via Drift ORM (^2.18.0)
- **Code Generation:** build_runner (^2.4.9) + drift_dev (^2.18.0)
- **PDF Generation:** pdf (^3.10.8) + printing (^5.12.0)
- **Charts:** fl_chart (^1.0.0)
- **Linting:** flutter_lints (^6.0.0)

## Project Structure

```
lib/
├── main.dart                      # App entry point, Provider setup, theme
├── database/
│   ├── database.dart              # Drift table definitions and database class
│   └── database.g.dart            # Generated Drift code (DO NOT EDIT)
├── models/
│   └── line_item.dart             # Invoice line item model with JSON serialization
├── screens/
│   ├── main_screen.dart           # Bottom navigation bar (8 tabs)
│   ├── home_screen.dart           # Task/to-do list view
│   ├── clients/                   # Client CRUD screens
│   ├── projects/                  # Project CRUD screens
│   ├── time_tracker/              # Timer, time entry add/edit screens
│   ├── invoices/                  # Invoice management and editing
│   ├── expenses/                  # Expense tracking screens
│   ├── reports/                   # Analytics and charts
│   ├── settings/                  # Company settings configuration
│   └── todos/                     # To-do editing screen
├── utils/
│   └── pdf_generator.dart         # PDF invoice generation utility
test/
└── widget_test.dart               # Basic widget smoke test (placeholder)
```

Platform directories (`android/`, `ios/`, `macos/`, `linux/`, `windows/`, `web/`) contain platform-specific build configurations.

## Common Commands

```bash
# Install dependencies
flutter pub get

# Run code generation (required after changing database schema)
dart run build_runner build --delete-conflicting-outputs

# Run the app
flutter run

# Run static analysis
flutter analyze

# Format code
dart format .

# Run tests
flutter test
```

## Database

The app uses Drift ORM with SQLite. The database schema is defined in `lib/database/database.dart` with 7 tables:

| Table | Purpose |
|-------|---------|
| `Clients` | Client records with name, email, address, currency |
| `Projects` | Projects linked to clients with hourly rate and status |
| `TimeEntries` | Time records with start/end, billable/billed/logged flags |
| `Expenses` | Expense records with optional mileage tracking |
| `Invoices` | Invoice records with JSON-serialized line items |
| `Todos` | Task items linked to projects with priority and deadlines |
| `CompanySettings` | Company name, address, logo path for invoice letterhead |

**Schema version:** 3. Current migration handles v1→v2 (adds `isLogged` column to TimeEntries) and v2→v3 (cascade delete rules).

### Important: Code Generation

`database.g.dart` is auto-generated by Drift. After modifying table definitions in `database.dart`, regenerate with:

```bash
dart run build_runner build --delete-conflicting-outputs
```

Never edit `database.g.dart` manually.

## Architecture Patterns

- **Provider at root:** `AppDatabase` is provided at the widget tree root via `Provider<AppDatabase>` in `main.dart`. Access it in widgets with `Provider.of<AppDatabase>(context)`.
- **Feature-based screen organization:** Each domain feature (clients, projects, time_tracker, etc.) has its own subdirectory under `screens/`.
- **StatefulWidget pattern:** Screens use `StatefulWidget` with direct database queries. No separate repository or service layer.
- **Foreign keys with cascade delete:** Deleting a client cascades to its projects, which cascades to time entries, expenses, and todos.
- **Dark theme:** The app uses a dark theme with deepPurple as the seed color (`lib/main.dart`).

## Key Conventions

- **No separate state management layer:** Database operations are called directly from widget code using the Drift-generated API.
- **Nullable fields:** Optional data uses Dart nullable types, mirrored as `.nullable()` in Drift table columns.
- **Currency:** Stored per-client (defaults to 'USD'). Formatting uses the `intl` package.
- **Invoice line items:** Stored as JSON text in the `lineItemsJson` column; the `LineItem` model in `models/line_item.dart` handles serialization.
- **Project status:** Text field with values like 'Active' (default).
- **Time entries:** Support three independent boolean flags — `isBillable`, `isBilled`, and `isLogged`.

## Testing

The test suite is minimal — `test/widget_test.dart` contains a default Flutter counter smoke test that does not match the actual app. Run tests with `flutter test`, but expect the existing test to fail since the app no longer has a counter widget.

## CI/CD

No CI/CD pipelines are configured. There are no GitHub Actions workflows.

## Things to Watch Out For

- **Generated files:** `database.g.dart` must be regenerated after schema changes. Don't edit it.
- **Schema migrations:** When adding/modifying database columns, increment `schemaVersion` in `AppDatabase` and add migration logic in the `onUpgrade` handler.
- **Platform dependencies:** SQLite native bindings (`sqlite3_flutter_libs`) are needed for mobile/desktop. The web platform may require different database configuration.
- **Test coverage:** The existing test is a placeholder and doesn't test actual app functionality.
